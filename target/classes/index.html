<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket File Upload</title>
</head>
<body>
<h1>File Upload via WebSocket</h1>

<!-- File input for selecting the file -->
<input type="file" id="fileInput">

<!-- Status output -->
<p id="status">Waiting for file...</p>

<script>
    // Create WebSocket connection
    const ws = new WebSocket('ws://localhost:1234');

    // Elements for user feedback
    const fileInput = document.querySelector('#fileInput');
    const statusText = document.querySelector('#status');

    // Handle WebSocket open event
    ws.onopen = function() {
        statusText.textContent = 'WebSocket connection established. You can now upload a file.';
        console.log('WebSocket connected');
    };

    // Handle file selection
    fileInput.addEventListener('change', (event) => {
        const file = event.target.files[0];

        if (file) {
            const reader = new FileReader();

            // When file is read, send it as an ArrayBuffer over WebSocket
            reader.onload = function(event) {
                const arrayBuffer = event.target.result;
                let upload = {
                    "filename" : file.name,
                    "size" : arrayBuffer.byteLength
                };
                ws.send(JSON.stringify(upload));  // Send file bytes over WebSocket
                ws.send(arrayBuffer);
                statusText.textContent = 'File uploaded successfully!';
                console.log('File sent');
            };

            // Read the file as ArrayBuffer
            reader.readAsArrayBuffer(file);
            statusText.textContent = 'Uploading file...';
        }
    });

    // Handle WebSocket message (optional for server responses)
    ws.onmessage = function(event) {
        console.log('Message from server:', event.data);
    };

    // Handle WebSocket error
    ws.onerror = function(error) {
        statusText.textContent = 'WebSocket error occurred.';
        console.error('WebSocket Error:', error);
    };

    // Handle WebSocket close event
    ws.onclose = function() {
        statusText.textContent = 'WebSocket connection closed.';
        console.log('WebSocket closed');
    };
</script>
</body>
</html>
